<!DOCTYPE html>
<html lang="en">
<head>
	<title>2017 PyConTW Talk</title>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- css style -->
	<link rel="stylesheet" href="lib/shower/themes/styles/screen-16x10.css">
	<link rel="stylesheet" href="lib/highlight/styles/github.css" type="text/css"/>
	<!--<link rel="stylesheet" href="shower/themes/material/styles/screen-16x10.css">
	<link rel="stylesheet" href="lib/highlight/styles/github.css" type="text/css"/>-->
</head>
<body class="shower list">

	<header class="caption">
		<h1>PyConTW 2017 TALK 用 Django 建立一個可以設定爬蟲排程任務與監控的網站</h1>
		<p>2017-06-11, <a href="https://chairco.github.io">YiChieh Chen(Jason)</p>
	</header>

	<section class="slide no-number" id="cover">
		<h2>用 Django 建立一個可以設定爬蟲排程任務與監控的網站</h2>
		<p>2017-06-11, <a href="https://chairco.github.io">YiChieh Chen(Jason)</a></p>
		<figure>
			<img class="cover" src="pictures/cover.jpg" alt="Hands on the orange typewriter in a park">
			<figcaption class="white">
				<a href="https://chairco.github.io/2017Talk-Django-crawler-monitor/">© YiChieh Chen</a>
			</figcaption>
		</figure>
		<style>
			#cover h2 {
				margin:30px 20 5;
				color:#FFF;
				text-align:center;
				font-size:50px;
				}
			#cover p {
				margin:10px 0 0;
				text-align:right;
				color:#FFF;
				font-style:italic;
				font-size:20px;
				}
				#cover p a {
					color:#FFF;
					}
		</style>
	</section>

	<section id="about-me" class="slide no-number twocol l60">
		<div class="right">
			<h2>About Me</h2>
			<ul>
				<li><a href="https://chairco.github.io">YiChieh(Jason)</a></li>
				<li>Master degree at the graduate school of Institute of Healthcare Information Management in CCU</li>
				<li>Program Chair of PyCon Taiwan 2017</li>
			</ul>
		</div>
		<div class="left">
			<div class="citation">
				<img class="fill w" src="pictures/me.jpg" alt="">
			</div>
		</div>
	</section>

	<section class="slide">
		<h2>Outline</h2>
		<ul>
			<li class="next">排程任務、工具、相關框架</li>
			<li class="next">建立一個排程任務網站</li>
			<li class="next">爬蟲程式範例</li>
			<li class="next">任務程式範例</li>
			<li class="next">如何透過 Django-Admin 建立任務</li>
			<li class="next">前端設計</li>
			<li class="next">Demo</li>
		</ul>
		<!--<p class="note">Shower ['ʃəuə] noun. A person or thing that shows.</p>-->
	</section>

	<section class="slide">
		<h2>Story as background </h2>
		<p>公司與工廠間再生產產品期間時需要經常即時的傳遞零組件資料，這些資料存在品牌公司的<em>資訊系統</em>。</p>
		<p>這些資料需要定期<strong>人工下載、比對</strong>，但是品牌公司會基於某些原因與理由不開放 API 讓系統之間串接，因此爬蟲成了資料下載的管道。</p>
		<p>一個工廠不會只生產一種產品，每種產品的零組件也不會只有幾十種。系統雖提供同一種下載模式（在同網站），但很多名稱不一定有規則，所以每個爬蟲程式多多少少需要一些客製化。<b>然後...然後...然後...</b></p>
	</section>

	<section class="slide">
        <div class="left">
	        <pre>
	            <code>try:</code>
	            <code class="mark">    driver.get("https://{}")</code>
	            <code>    content = wait.until(lambda driver:<br>        driver.find_element_by_id("accountname"),"link fail")</code>
	            <code class="mark">    wait.until(lambda driver: driver.find_element_by_id<br>       ("accountname"),"FAIL to find account")</code>
	            <code>    driver.find_element_by_id("accountname").send_keys("{}")</code>
	            <code>    driver.find_element_by_id("accountpassword").send_keys("{}")</code>
	            <code>    driver.find_element_by_id("continueFieldbutton").click()</code>
	        </pre>
        	<p><a href="https://gist.github.com/chairco/e0cbcdd66755e6130f3ed2b869889655">BAD IDEAL</a></p>
        </div>
    </section>

	<section class="slide twocol l65">
		<p>設定排程</p>
		<div class="citation">
			<img class="fill w" src="pictures/crontab.png" alt="crontab">
		</div>
	</section>

	<section class="slide">
		<figure>
			<img class="cover" src="pictures/bang.jpg" alt="bang">
		</figure>
	</section>

	<section class="slide">
		<figure>
			<img class="cover" src="pictures/heisdie.jpg" alt="law-in-shit">
		</figure>
	</section>

	<section class="slide">
		<h2>Story as background </h2>
		<figure>
			<blockquote>
				<p>電話響鈴聲～</p>
				<p>對方：資料又沒抓到啦</p>
				<p>對方：你什麼時候可以修好！！</p>
				<p>對方：我現在要資料！！</p>
				<p>對方：掛斷</p>
			</blockquote>
		</figure>
	</section>

	<section class="slide">
		<figure>
			<img class="cover" src="pictures/blockman.jpeg" alt="wtf">
		</figure>
	</section>

	<section class="slide">
		<h2 class="shout shrink">排程任務<br>工具與框架</h2>
	</section>

	<section class="slide twocol l65">
		<ol>
			<li>首先先講一點點關於 Directed Acyclic Graph （ DAG ）的知識。</li>
			<li>有些事情會有先後關係，舉例資料結構內用 Graph 來表示，vertex(穿襪子)、vertex(穿鞋子)與edge(先後關係)：</li>
			<li>時間軸當作主角，緣起緣滅、緣聚緣散，凡事都是 DAG</li>
		</ol>
		<dir class="left">
			<div class="citation">
				<img class="fill w" src="pictures/graph1.png" alt="graph1">
				<p>這樣的 Graph 顯示在穿鞋子之前必須先套上襪子。</p>
			</div>
		</dir>
	</section>

	<section class="slide twocol l65">
		<ul>
			<li>選課系統要如何確保在選修「演算法分析」之前，已經先選修「資料結構」，而在選修「資料結構」之前，已經先修完「程式(一)」與「離散數學」？</li>
			<li>關於這件事會用 Topological Sort(拓撲排序) 的演算法。就能確保我們在執行某些事情時照著某種順序進行。</li>
		</ul>
		<div class="left">
			<div class="citation">
				<img class="fill w" src="pictures/graph2.png" alt="graph2">
			</div>
		</div>
	</section>

	<section class="slide twocol l65">
		<h2>Topological Sort (拓撲排序)</h2>
		<div class="right">
			<ul>
				<li>若 Directed Acyclic Graph(DAG) 中存在一條 edge(X,Y)，那麼序列中，vertex(X) 一定要在 vertex(Y) 之前出現。</li>
				<li>更多可以<a href="http://interactivepython.org/runestone/static/pythonds/Graphs/toctree.html">參考</a>用 Python 實作資料結構。</li>
			</ul>
		</div>
		<div class="left">
			<div class="citation">
				<img class="fill w" src="pictures/graph3.png" alt="graph3">
				<p>edge(2,6)、edge(6,9)，那麼 Topological Sort 中，vertex(2) 一定要出現在 vertex(6) 之前，vertex(6) 一定要在 vertex(9) 前</p>
			</div>
		</div>
	</section>

	<section class="slide twocol l65">
		<div class="right">
			<p>實現一個排程的任務，就是要實作一個 <em>DAG</em>。 而且有很多使用 <i>Python</i> 開發的 workflow system (有國外大大稍微整理一下，大約<code>&lt;130&gt;</code>個)。天啊！</p>
		</div>
		<div class="left">
			<div class="citation">
				<img class="fill w" src="pictures/workflow_list.png" alt="workflow_list">
				<p>Ref: <a href="https://github.com/common-workflow-language/common-workflow-language/wiki/Existing-Workflow-systems">Computational Data Analysis Workflow Systems</a></p>
			</div>
		</div>
	</section>

	<section class="slide twocol l65">
		<div class="right">
			<h2><a href="https://github.com/thieman/dagobah">Dagobah</a></h2>
			<ul>
				<li>一個用 Python 實作的 simple dependency-based job scheduler。</li>
				<li>採 cron 語法在網頁上設定 schedule 然後透過拖、拉、放的方式在網頁上連結不同 job 來建立任務。</li>
			</ul>
		</div>
		<div class="left">
			<div class="citation">
				<img class="fill w" src="pictures/dagobah.png" alt="dagobah">
			</div>
		</div>
	</section>

	<section class="slide twocol l65">
		<div class="right">
			<h2><a href="https://github.com/spotify/luigi">Luigi</a></h2>
			<ul>
				<li>Spotify 所開發的開源軟體。主要協助建立複雜與批次的 pipline jobs。</li>
				<li>優勢是用來處理高度相依的工作流程管理和可視覺化。分別用 Python 撰寫兩大模組達成。</li>
				<li>沒有提供 job task 的 schedule module。</li>
			</ul>
		</div>
		<div class="left">
			<div class="citation">
				<img class="fill w" src="pictures/luigi.png" alt="luigi">
			</div>
		</div>
	</section>

	<section class="slide twocol l65">
		<div class="right">
			<h2><a href="https://github.com/pinterest/pinball">Pinball</a></h2>
			<ul>
				<li>也是一個 workflow system 但比較特別是遵守 master-client (或是 master-worker) 的架構。所以它是透過 master 來管理例如 schedule, worker ….</li>
				<li>將 hadoop/hive/spark jobs 整合的很不錯。</li>
			</ul>
		</div>
		<div class="left">
			<div class="citation">
				<img class="fill w" src="pictures/pinball.png" alt="pinball">
			</div>
		</div>
	</section>

	<section class="slide twocol l65">
		<div class="right">
			<h2><a href="https://github.com/apache/incubator-airflow">Airflow</a></h2>
			<ul>
				<li>Airbnb 的開源軟體。採 Python 開發。與剛剛提到的 Luigi 和 Pinball 相似。</li>
				<li>後端主要是以 Flask 和 Celery 建立。</li>
			</ul>
		</div>
		<div class="left">
			<div class="citation">
				<img class="fill w" src="pictures/airflow.png" alt="airflow">
			</div>
		</div>
	</section>

	<section class="slide">
		<h2><a href="http://bytepawn.com/luigi-airflow-pinball.html">Luigi vs Airflow vs Pinball</a></h2>
		<table>
			<tr>
				<th scope="col"></th>
				<th>Luigi</th>
				<th>Airflow</th>
				<th>Pinball</th>
			</tr>
			<tr>
				<th scope="row">github stars</th>
				<td>4029</td>
				<td>1798</td>
				<td>506</td>
			</tr>
			<tr>
				<th scope="row">calendar scheduling</th>
				<th>no, use cron</th>
				<th>yes, LocalScheduler</th>
				<th>yes</th>
			</tr>
			<tr>
				<th scope="row">web dashboard</th>
				<td>minimal</td>
				<td>nice</td>
				<td>yes</td>
			</tr>
			<tr>
				<th scope="row">multiple dags</th>
				<td>no, just one</td>
				<td>yes</td>
				<td>yes</td>
			</tr>
		</table>
	</section>

	<section class="slide">
		<figure>
			<img class="cover" src="pictures/rayfun.png" alt="rayfun">
		</figure>
	</section>

	<section class="slide">
		<h2 class="shout">建立一個<br>排程任務網站</h2>
	</section>

	<section class="slide">
		<h2>RequirementS</h2>
		<ol>
			<li>簡單整合任務排程（整合起來不複雜）</li>
			<li class="next">可以把爬蟲的程式簡單的包進進去（模組化）</li>
			<li class="next">監控流程與狀態（開始運行提示、運行時的狀況）</li>
			<li class="next">容易就做出來的前端頁面（熟悉？）</li>
			<li class="next">最後...我就是想用 Django</li>
		</ol>
	</section>

	<section class="slide grid">
		<h2>Django 的套件從那找？</h2>
		<p>有一個挺好用的網站叫 <a href="https://djangopackages.org/grids/g/search/">Django Packages </a>網羅了許多<b> Django </b>套件，其中有一個分類叫：<em>Workers, Queues, and Tasks</em> 有列出很多相關的套件。</p>
		<div class="left">
			<div class="citation">
				<img class="fill w" src="pictures/djangopkg.png" alt="djpkg">
			</div>
		</div>
	</section>

	<section class="slide" id="picture">
		<h2>Pictures</h2>
		<figure>
			<img class="cover" src="pictures/pkglist.png" alt="pkglist">
		</figure>
		<style>
			#picture h2 {
				color:#FFF;
				}
		</style>
	</section>

	<section class="slide">
		<h2>等等，你是不是還忘記些什麼？Celery 大大呢？</h2>
		<ul>
			<li class="next"><a href="https://github.com/Koed00/django-q/issues/8">Why not Celery</a></li>
			<ul>
				<li class="next">Django native</li>
				<li class="next">簡單設定</li>
				<li class="next">快速</li>
			</ul>
		</ul>
	</section>

	<section class="slide">
		<h2>Django-Q 簡介與設定方式</h2>
		<figure>
			<blockquote>
				<p>Django Q is a <b>native</b> Django task queue, scheduler and worker application using Python multiprocessing.</p>
				<p>Django Q is tested with: Python 2.7 & 3.6. Django 1.8.18 LTS, 1.10.7 and 1.11</p>
			</blockquote>
		</figure>
	</section>

	<section class="slide">
		<h2>Feature</h2>
		<ul>
			<li>Multiprocessing worker pools</li>
			<li>Asynchronous tasks</li>
			<li>Scheduled and repeated tasks</li>
			<li>Encrypted and compressed packages</li>
			<li>Failure and success database or cache</li>
		</ul>
	</section>

	<section class="slide">
		<h2>Feature</h2>
		<ul>
			<li>Result hooks, groups and chains</li>
			<li>Django Admin integration</li>
			<li>PaaS compatible with multiple instances</li>
			<li>Multi cluster monitor</li>
			<li>Redis, Disque, IronMQ, SQS, MongoDB or ORM</li>
			<li>Rollbar support</li>
		</ul>
	</section>

	<section class="slide">
		<h2>安裝與設定方式</h2>
		<p>Install the latest version with <b>pip</b>:<br>
			<code>$ pip install django-q</code>
		<p>Add django_q to INSTALLED_APPS in your projects <b>settings.py</b>:
		<code>
			INSTALLED_APPS = ( <br>
			    # other apps <br>
			    'django_q', <br>
			)
		</code>
		</p>
	</section>

	<section class="slide">
		<h2>安裝與<a href="https://django-q.readthedocs.io/en/latest/configure.html">設定</a>方式</h2>
		<p>
			Run Django migrations to create the database tables:<br>
			<code>$ python manage.py migrate</code><br>
			Choose a message broker , configure it and install the appropriate client library.<br>
			<code>
				Q_CLUSTER = {
				    'name': 'DjangORM', <br>
				    'workers': 1, <br>
				    'timeout': 1800,
				    'retry': 120,
				    'queue_limit': 50,
				    'bulk': 10,
				    'orm': 'default' <br>
				}
			</code>
		</p>
	</section>

	<section class="slide">
		<h2>安裝與設定方式</h2>
		<p>
			Run Django Q cluster in order to handle tasks async:<br>
			<code>$ python manage.py qcluster</code>
		</p>
		<p>基本上就完成所有 Django-Q 的設定了。接者讓 Django wsgi server 跑起來。<br>
			<code>$ python manage.py runserver</code>
		</p>
	</section>

	<section class="slide grid">
		<p>在瀏覽器輸入 <code>localhost:8000/admin</code>, 登入後看到 Django-Q 就成功了。簡單吧。</p>
		<div class="left">
			<div class="citation">
				<img class="fill w" src="pictures/django-q-1.png" alt="django-admin">
			</div>
		</div>
	</section>

	<section class="slide">
		<h2 class="shout">開始來<br>寫爬蟲吧</h2>
	</section>

	<section class="slide">
		<p>首先我想把爬蟲都放在 crawler 這個 app之下:<br>
			<code>$ python manage.py startapp crawler</code>
		<p>這個 app 就專門負責爬蟲任務，接著建立一個 <b>crawler.py</b> 的程式。爬蟲通常會用到幾個套件
		<em>requests, selenium, BeautifulSoup</em> 都先裝起來。<br>
			<code>$ pip install requests, selenium, BeautifulSoup4</code>
			安裝完成之後我們就可以開始來寫 crawler.py，crawler.py 目的就是將我們想做的爬蟲功能都做進去。
		</p>
	</section>

	<section class="slide">
        <h2><a href="https://github.com/chairco/2017Talk-Django-crawler-monitor/blob/master/code/pycontw/crawler/crawler.py">Code samples</a></h2>
        <pre>
            <code class="mark">class Crawler(object):</code>
            <code>  </code>
            <code class="mark">def __init__(self, *args, **kwargs):</code>
            <code>    self.BASE_DIR = settings.BASE_DIR</code>
            <code>    ...</code>
            <code class="mark">def driver(self):</code>
            <code>    ...</code>
        </pre>
    </section>

    <section class="slide">
        <h2><a href="https://github.com/chairco/2017Talk-Django-crawler-monitor/blob/master/code/pycontw/crawler/crawler.py">Code samples</a></h2>
        <pre>
            <code class="mark">def test(url):</code>
            <code>    PHANTOMJS='{path}'</code>
            <code>    crawler = Crawler(driver_path=PHANTOMJS):</code>
            <code>    driver = crawler.driver()</code>
            <code>    driver.get(url)</code>
            <code>    pageSource = driver.page_source</code>
            <code>    soup = bs(pageSource, "html.parser")</code>
            <code>    driver.close()</code>
            <code>    return pageSource</code>
        </pre>
    </section>

    <section class="slide">
        <h2><a href="https://github.com/chairco/2017Talk-Django-crawler-monitor/blob/master/code/pycontw/crawler/crawler.py">Code samples</a></h2>
        <pre>
            <code class="mark">def test(url):</code>
            <code>    PHANTOMJS='{path}'</code>
            <code>    crawler = Crawler(driver_path=PHANTOMJS):</code>
            <code>    driver = crawler.driver()</code>
            <code>    driver.get(url)</code>
            <code>    pageSource = driver.page_source</code>
            <code>    soup = bs(pageSource, "html.parser")</code>
            <code>    driver.close()</code>
            <code>    return soup</code>
        </pre>
    </section>

    <section class="slide">
        <h2><a href="https://github.com/chairco/2017Talk-Django-crawler-monitor/blob/master/code/pycontw/crawler/crawler.py">Code samples</a></h2>
        <p>隨便爬個網頁，得到一些結果。就完成了爬蟲程式。</p>
        <pre>
            <code class="mark">def test(url):</code>
            <code>    logging.basicConfig(level=logging.INFO,
        format='%(asctime)s:%(name)s:%(levelname)s:%(message)s')</code>
            <code>    print(test(url='http://pala.tw/js-example/'))</code>
        </pre>
    </section>

	<section class="slide">
		<h2 class="shout">接著<br>來完成 Tasks</h2>
	</section>

	<section class="slide">
		<p>在 <b>/crawler/</b> 下建立一個 <b>tasks.py</b> 這個檔案將用來撰寫與管理我們的任務。接著我們把前面用來測試的程式碼 <code>def test(url)</code>加到 <b>tasks.py</b> 內，就完成第一隻 task。</p>
		<p>接著進入到 admin 的後台，新增一個 schedule task 測試看看。</p>
		<div class="left">
			<div class="citation">
				<img class="fill w" src="pictures/schedule_tasks.png" alt="schedule_tasks">
			</div>
		</div>
	</section>

	<section class="slide">
		<div class="left">
			<p>接著輸入這個 task 需要的參數，與設定重複次數、執行時間等等</p>
			<img class="fill w" src="pictures/schedule_tasks_2.png" alt="schedule_tasks_2">
		</div>
	</section>

	<section class="slide">
		<p><code>$ python manage.py qcluster</code> 的介面會顯示執行時狀態</p>
		<div class="left">
			<img class="fill w" src="pictures/process.png" alt="process">
		</div>
	</section>

	<section class="slide">
		<div class="left">
			<p>Scheduled tasks 設定成功的畫面，最後一欄會顯示目前執行結果的狀態。</p>
			<img class="fill w" src="pictures/schedule_tasks_3.png" alt="schedule_tasks_3">
			<p>Successful tasks 會顯示執行成功的 Tasks</p>
			<img class="fill w" src="pictures/schedule_tasks_4.png" alt="schedule_tasks_4">
		</div>
	</section>

	<section class="slide">
		<div class="left">
			<p>Failed tasks 則會顯示執行不成功的 Tasks</p>
			<img class="fill w" src="pictures/schedule_tasks_5.png" alt="schedule_tasks_5">
		</div>
	</section>

	<section class="slide">
		<h2 class="shout">前端頁面<br>設計</h2>
	</section>

	<section class="slide">
        <p>希望有一個頁面可以即時的看到任務正在執行，和已經結束的任務。還能點進去觀看任務詳細執行歷程。</p>
        <div class="left">
			<div class="citation">
				<img class="fill w" src="pictures/tasks.png" alt="tasks">
			</div>
		</div>
    </section>

    <section class="slide">
        <p>每個 task 記錄每個細節。</p>
        <div class="left">
			<div class="citation">
				<img class="fill w" src="pictures/log.png" alt="log">
			</div>
		</div>
    </section>

	<section class="slide">
        <p>首先在 <b>crawler/views.py</b> 新增一個 <code>view_task</code> 取的所有 tasks</p>
        <pre>
            <code class="mark">def view_task(request, id):</code>
            <code>    task = get_object_or_404(Task, id=id)</code>
            <code>    result = task.result</code>
            <code>    if task.func == 'crawler.tasks.crawler_job':</code>
            <code>        return render(request, 'crawler/tasks_detail.html', {</code>
            <code>            'result': result,})</code>
            <code>    return Http404(</code>
            <code>    'Given task of type %s does not have the....'</code>
            <code>    % task.func)</code>
        </pre>
    </section>

    <section class="slide">
    	<p><code>def crawler(request)</code> 取得每個 task 的 detail</p>
        <pre>
            <code class="mark">def crawler(request):</code>
            <code>    queue_crawler = OrmQ.objects.all().order_by('lock')</code>
            <code>    complete_crawler = Task.objects.all().filter(</code>
            <code>        func__exact='crawler.tasks.crawler_job',</code>
            <code>    )</code>
            <code>    return render(request, 'crawler/tasks_crawler.html', {</code>
            <code>        'queue_crawler': queue_crawler,</code>
            <code>        'complete_crawler': complete_crawler</code>
            <code>    })</code>
        </pre>
    </section>

    <section class="slide">
        <p>
        	介紹一個好用的 logging 套件，<a href="https://github.com/Python-Logging-For-Human/lazy_logger">lazy_logger</a>。
        </p>
        <div class="left">
			<div class="citation">
				<img class="fill w" src="pictures/lazy_logger.png" alt="lazy_logger">
			</div>
		</div>
    </section>

    <section class="slide">
		<h2 class="shout">Demo</h2>
	</section>

	<section class="slide" id="see-more">
		<h2 class="shout">
			<img src="pictures/logo.svg" alt="Shower logo">
			<a href="https://github.com/shower/shower">See more on GitHub</a>
		</h2>
		<style>
			#see-more h2 {
				font-size:100px
				}
			#see-more img {
				width:0.72em;
				height:0.72em;
				}
		</style>
	</section>

	<footer class="badge">
		<a href="https://github.com/chairco/2017Talk-Django-crawler-monitor">Fork me on GitHub</a>
	</footer>

	<div class="progress"></div>

	<!-- Library -->
	<!-- <script src="lib/shower/shower.min.js"></script>
	<script src="lib/highlight/highlight.pack.js" type="text/javascript" charset="utf-8"></script> -->
	<script>
		hljs.initHighlightingOnLoad();
	</script>
	<script src="shower/shower.min.js"></script>
	<!-- Copyright © 2017 Yours Truly, Famous Inc. -->

</body>
</html>
